datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                       Int                   @id @default(autoincrement())
  email                    String                @unique
  name                     String?
  password                 String? // Hashed password (nullable for backward compatibility)
  emailVerified            Boolean               @default(false)
  emailVerificationToken   String?
  emailVerificationExpires DateTime?
  passwordResetToken       String?
  passwordResetExpires     DateTime?
  lastLoginAt              DateTime?
  createdAt                DateTime              @default(now())
  updatedAt                DateTime              @updatedAt
  orders                   Order[]
  roles                    Role[]                @relation("UserRoles")
  onboarding               OnboardingState?
  webhookSubscriptions     WebhookSubscription[]
  payments                 Payment[]
  subscription             Subscription?
  invoices                 Invoice[]
  WooCommerceStore         WooCommerceStore[]
  refreshTokens            RefreshToken[]
  sellerProfiles           WarehouseSellerProfile[]
}

model Order {
  id          Int         @id @default(autoincrement())
  orderNumber String      @unique
  total       Float
  status      OrderStatus
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  userId        Int
  user          User           @relation(fields: [userId], references: [id])
  carrierId     Int?
  carrier       Carrier?       @relation(fields: [carrierId], references: [id])
  warehouseId   Int?
  warehouse     Warehouse?     @relation(fields: [warehouseId], references: [id])
  shipments     Shipment[]
  returns       Return[]       @relation("OrderReturns")
  codRemittance CodRemittance?
  payments      Payment[]

  destinationName         String?
  destinationPhone        String?
  destinationAddressLine1 String?
  destinationAddressLine2 String?
  destinationCity         String?
  destinationState        String?
  destinationPincode      String?
  destinationCountry      String? @default("India")
  packageWeightGrams      Int?
  packageLengthCm         Float?
  packageWidthCm          Float?
  packageHeightCm         Float?
}

model Carrier {
  id            Int             @id @default(autoincrement())
  name          String          @unique
  apiKey        String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  orders        Order[]
  shippingRates ShippingRate[]
  shipments     Shipment[]
  pincodeZones  PincodeZone[]
  surcharges    RateSurcharge[]
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

model ShippingRate {
  id                    Int      @id @default(autoincrement())
  carrierId             Int
  serviceName           String
  rate                  Float
  estimatedDeliveryDays Int
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  carrier Carrier @relation(fields: [carrierId], references: [id])
}

model Shipment {
  id                 Int            @id @default(autoincrement())
  trackingNumber     String
  status             ShipmentStatus
  orderId            Int
  carrierId          Int
  warehouseId        Int?
  shippedAt          DateTime?
  deliveredAt        DateTime?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  originPincode      String?
  destinationPincode String?
  weightGrams        Int?
  lengthCm           Float?
  widthCm            Float?
  heightCm           Float?

  order          Order           @relation(fields: [orderId], references: [id])
  carrier        Carrier         @relation(fields: [carrierId], references: [id])
  warehouse      Warehouse?      @relation(fields: [warehouseId], references: [id])
  label          ShippingLabel?
  trackingEvents TrackingEvent[]
  pickup         Pickup?
  manifestItems  ManifestItem[]
  ndrCase        NdrCase?
  ewayBill       EwayBill?
}

enum ShipmentStatus {
  PENDING
  SHIPPED
  IN_TRANSIT
  DELIVERED
  CANCELLED
}

/// Status of a shipping label lifecycle
enum LabelStatus {
  PENDING
  GENERATED
  FAILED
  VOIDED
}

model ShippingLabel {
  id          Int         @id @default(autoincrement())
  shipmentId  Int         @unique
  labelNumber String      @unique
  carrierCode String
  serviceName String?
  format      String? // e.g., PDF, ZPL
  labelUrl    String?
  status      LabelStatus @default(PENDING)
  requestedAt DateTime    @default(now())
  generatedAt DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  shipment Shipment @relation(fields: [shipmentId], references: [id])
}

model TrackingEvent {
  id             Int      @id @default(autoincrement())
  shipmentId     Int
  trackingNumber String
  externalId     String?  @unique
  status         String
  subStatus      String?
  description    String?
  eventCode      String?
  location       String?
  occurredAt     DateTime
  raw            Json?
  createdAt      DateTime @default(now())

  shipment Shipment @relation(fields: [shipmentId], references: [id])

  @@index([shipmentId, occurredAt])
}

model PincodeZone {
  id        Int      @id @default(autoincrement())
  pincode   String   @unique
  zone      String
  oda       Boolean  @default(false)
  carrierId Int?
  carrier   Carrier? @relation(fields: [carrierId], references: [id])
}

model Warehouse {
  id           Int      @id @default(autoincrement())
  name         String
  code         String   @unique
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  pincode      String
  country      String   @default("India")
  latitude     Float?
  longitude    Float?
  capacityCbm  Float?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  orders            Order[]
  shipments         Shipment[]
  stocks            WarehouseStock[]
  coverages         WarehouseCoverage[]
  sellerProfiles    WarehouseSellerProfile[]
  invoices          Invoice[]
  invoiceSequences  InvoiceSequence[]
}

model WarehouseStock {
  id           Int      @id @default(autoincrement())
  warehouseId  Int
  sku          String
  quantity     Int      @default(0)
  reorderLevel Int?
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@index([warehouseId])
  @@index([sku])
}

model WarehouseCoverage {
  id             Int      @id @default(autoincrement())
  warehouseId    Int
  pincode        String
  serviceLevel   String?
  tatDays        Int?
  isOda          Boolean  @default(false)
  odaFee         Float?
  minWeightGrams Int?
  maxWeightGrams Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([warehouseId, pincode])
  @@index([warehouseId, pincode], name: "warehouse_pincode_idx")
}

model WarehouseSellerProfile {
  id                 Int       @id @default(autoincrement())
  warehouseId        Int
  userId             Int
  profileName        String
  legalName          String
  displayName        String?
  gstin              String
  pan                String?
  tan                String?
  cin                String?
  addressLine1       String
  addressLine2       String?
  city               String
  state              String
  pincode            String
  country            String   @default("India")
  email              String?
  phone              String?
  bankAccountNumber  String?
  bankIfsc           String?
  bankName           String?
  bankBranch         String?
  logoUrl            String?
  signatureUrl       String?
  metadata           Json?
  isDefault          Boolean  @default(false)
  isActive           Boolean  @default(true)
  validFrom          DateTime @default(now())
  validTo            DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id])
  invoices  Invoice[]

  @@index([warehouseId, userId])
  @@index([warehouseId, isActive])
}

model RateSurcharge {
  id        Int      @id @default(autoincrement())
  carrierId Int
  name      String
  percent   Float? // e.g., fuel surcharge
  flat      Float? // e.g., ODA flat fee
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  carrier Carrier @relation(fields: [carrierId], references: [id])
}

model Return {
  id                Int          @id @default(autoincrement())
  returnNumber      String       @unique
  status            ReturnStatus
  reason            String
  pickupScheduledAt DateTime?
  orderId           Int
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  order Order @relation("OrderReturns", fields: [orderId], references: [id])
}

model Pickup {
  id          Int       @id @default(autoincrement())
  shipmentId  Int       @unique
  scheduledAt DateTime
  confirmedAt DateTime?
  status      String    @default("SCHEDULED")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  shipment Shipment @relation(fields: [shipmentId], references: [id])
}

model Manifest {
  id         Int            @id @default(autoincrement())
  manifestNo String         @unique
  createdAt  DateTime       @default(now())
  items      ManifestItem[]
}

model ManifestItem {
  id         Int      @id @default(autoincrement())
  manifestId Int
  shipmentId Int
  createdAt  DateTime @default(now())

  manifest Manifest @relation(fields: [manifestId], references: [id])
  shipment Shipment @relation(fields: [shipmentId], references: [id])

  @@unique([manifestId, shipmentId])
}

model NdrCase {
  id          Int      @id @default(autoincrement())
  shipmentId  Int      @unique
  reason      String
  status      String   @default("OPEN")
  actionNotes String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  shipment Shipment @relation(fields: [shipmentId], references: [id])
}

model CodRemittance {
  id          Int       @id @default(autoincrement())
  orderId     Int       @unique
  amount      Float
  remittedAt  DateTime?
  status      String    @default("PENDING")
  referenceId String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  order Order @relation(fields: [orderId], references: [id])
}

model WebhookSubscription {
  id        Int      @id @default(autoincrement())
  userId    Int
  event     String
  targetUrl String
  secret    String?
  createdAt DateTime @default(now())
  active    Boolean  @default(true)

  user User @relation(fields: [userId], references: [id])

  @@index([userId, event])
}

model IdempotencyKey {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  scope     String
  result    Json?
  createdAt DateTime @default(now())
}

enum ReturnStatus {
  REQUESTED
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED
}

model ShopifyStore {
  id          String         @id @default(uuid())
  shopDomain  String         @unique
  accessToken String
  connectedAt DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  orders      ShopifyOrder[]
}

model ShopifyOrder {
  id               String    @id @default(uuid())
  orderNumber      String    @unique
  total            Float
  status           String
  storeId          String
  shopifyCreatedAt DateTime?
  processedAt      DateTime?
  currency         String?
  customerEmail    String?
  customerName     String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime? @updatedAt

  store ShopifyStore @relation(fields: [storeId], references: [id])
}

model ShopifyWebhookEvent {
  id         String   @id
  topic      String
  shopDomain String
  receivedAt DateTime @default(now())
}

// WooCommerce Models
model WooCommerceStore {
  id             String   @id @default(uuid())
  userId         Int
  storeUrl       String   @unique
  consumerKey    String
  consumerSecret String
  connectedAt    DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user   User               @relation(fields: [userId], references: [id])
  orders WooCommerceOrder[]

  @@index([userId])
}

model WooCommerceOrder {
  id                   String    @id @default(uuid())
  orderNumber          String    @unique
  total                Float
  status               String
  storeId              String
  woocommerceCreatedAt DateTime?
  processedAt          DateTime?
  currency             String?
  customerEmail        String?
  customerName         String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime? @updatedAt

  store WooCommerceStore @relation(fields: [storeId], references: [id])

  @@index([storeId])
  @@index([orderNumber])
}

model Role {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?
  users       User[]  @relation("UserRoles")
}

/// Tracks account onboarding milestones (AOM) for a user
enum OnboardingStatus {
  NOT_STARTED
  IN_PROGRESS
  BLOCKED
  COMPLETED
}

model OnboardingState {
  id                   Int              @id @default(autoincrement())
  userId               Int              @unique
  status               OnboardingStatus @default(NOT_STARTED)
  // milestone flags
  kycSubmitted         Boolean          @default(false)
  kycApproved          Boolean          @default(false)
  pickupAddressAdded   Boolean          @default(false)
  pickupVerified       Boolean          @default(false)
  carrierConnected     Boolean          @default(false)
  ecommerceConnected   Boolean          @default(false)
  paymentsConfigured   Boolean          @default(false)
  testLabelGenerated   Boolean          @default(false)
  firstPickupScheduled Boolean          @default(false)
  // computed guidance
  nextAction           String?
  blockedReason        String?
  metadata             Json?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt

  user User @relation(fields: [userId], references: [id])
}

// Payment Models
enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
  CANCELLED
}

enum PaymentGateway {
  STRIPE
  RAZORPAY
}

enum PaymentMethod {
  CARD
  UPI
  NETBANKING
  WALLET
  COD
}

enum PaymentReconciliationStatus {
  NOT_APPLICABLE
  PENDING_REVIEW
  MATCHED
  PARTIAL
  MISMATCH
}

model Payment {
  id               String         @id @default(uuid())
  userId           Int
  orderId          Int?
  invoiceId        String?
  amount           Float
  currency         String         @default("INR")
  status           PaymentStatus  @default(PENDING)
  gateway          PaymentGateway
  gatewayPaymentId String? // External payment ID from gateway
  paymentMethod    PaymentMethod?
  metadata         Json?
  failureReason    String?
  refundedAmount   Float          @default(0)
  reconciliationStatus PaymentReconciliationStatus @default(PENDING_REVIEW)
  reconciliationMetadata Json?
  reconciledAt     DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  user    User     @relation(fields: [userId], references: [id])
  order   Order?   @relation(fields: [orderId], references: [id])
  invoice Invoice? @relation(fields: [invoiceId], references: [id])
  refunds Refund[]

  @@index([userId])
  @@index([orderId])
  @@index([invoiceId])
  @@index([gatewayPaymentId])
  @@index([status])
}

model Refund {
  id              String        @id @default(uuid())
  paymentId       String
  amount          Float
  currency        String        @default("INR")
  gatewayRefundId String? // External refund ID from gateway
  reason          String?
  status          PaymentStatus @default(PENDING)
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([gatewayRefundId])
}

// Subscription Models
enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PAST_DUE
  TRIALING
}

enum SubscriptionPlan {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

model Subscription {
  id                    String             @id @default(uuid())
  userId                Int                @unique
  plan                  SubscriptionPlan   @default(FREE)
  status                SubscriptionStatus @default(ACTIVE)
  gateway               PaymentGateway
  gatewaySubscriptionId String? // External subscription ID
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  cancelAtPeriodEnd     Boolean            @default(false)
  cancelledAt           DateTime?
  trialStart            DateTime?
  trialEnd              DateTime?
  metadata              Json?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  user     User      @relation(fields: [userId], references: [id])
  invoices Invoice[]

  @@index([userId])
  @@index([status])
}

// Invoice Models
enum InvoiceStatus {
  DRAFT
  PENDING
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

model Invoice {
  id             String        @id @default(uuid())
  invoiceNumber  String        @unique
  subscriptionId String?
  userId         Int
  warehouseId    Int?
  sellerProfileId Int?
  buyerLegalName String?
  buyerGstin     String?
  buyerState     String?
  buyerEmail     String?
  buyerPhone     String?
  buyerAddressLine1 String?
  buyerAddressLine2 String?
  buyerCity      String?
  buyerPincode   String?
  buyerCountry   String?
  amount         Float
  taxAmount      Float         @default(0)
  cgstAmount     Float         @default(0)
  sgstAmount     Float         @default(0)
  igstAmount     Float         @default(0)
  gstType        String?
  totalAmount    Float
  currency       String        @default("INR")
  status         InvoiceStatus @default(DRAFT)
  sequenceNumber Int?
  financialYear  String?
  dueDate        DateTime?
  paidAt         DateTime?
  invoiceUrl     String? // PDF URL
  pdfStorageKey  String?
  pdfUploadedAt  DateTime?
  gstnAckNumber  String?
  gstnAckDate    DateTime?
  gstnSignedPayload String?
  gstnSignatureValid Boolean    @default(false)
  emailDeliveryStatus String    @default("PENDING")
  emailDeliveryAttempts Int      @default(0)
  emailDeliveredAt DateTime?
  metadata       Json?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  subscription Subscription? @relation(fields: [subscriptionId], references: [id])
  user         User          @relation(fields: [userId], references: [id])
  warehouse    Warehouse?    @relation(fields: [warehouseId], references: [id])
  sellerProfile WarehouseSellerProfile? @relation(fields: [sellerProfileId], references: [id])
  invoiceItems InvoiceItem[]
  payments     Payment[]
  ewayBill     EwayBill?

  @@index([userId])
  @@index([subscriptionId])
  @@index([invoiceNumber])
  @@index([warehouseId])
  @@index([sellerProfileId])
  @@index([financialYear, warehouseId])
  @@index([status])
}

model InvoiceItem {
  id          Int      @id @default(autoincrement())
  invoiceId   String
  description String
  quantity    Int      @default(1)
  unitPrice   Float
  totalPrice  Float
  hsnCode     String? // HSN/SAC code for GST
  taxRate     Float    @default(0)
  taxAmount   Float    @default(0)
  cgstAmount  Float    @default(0)
  sgstAmount  Float    @default(0)
  igstAmount  Float    @default(0)
  gstType     String?
  createdAt   DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model InvoiceSequence {
  id             Int      @id @default(autoincrement())
  warehouseId    Int
  financialYear  String
  lastSequence   Int      @default(0)
  prefix         String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([warehouseId, financialYear])
}

model RefreshToken {
  id        Int       @id @default(autoincrement())
  userId    Int
  token     String    @unique
  expiresAt DateTime
  createdAt DateTime  @default(now())
  revokedAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

// E-way Bill Model
model EwayBill {
  id              Int       @id @default(autoincrement())
  shipmentId      Int       @unique
  invoiceId       String?   @unique
  ewayBillNumber  String    @unique
  consignorGstin  String
  consigneeGstin  String
  placeOfDispatch String
  placeOfDelivery String
  invoiceValue    Float
  invoiceNumber   String
  invoiceDate     DateTime
  hsnCode         String
  reason          String?
  transporterId   String?
  vehicleNumber   String?
  status          String    @default("ACTIVE") // ACTIVE, EXPIRED, CANCELLED
  validUntil      DateTime?
  ewayBillUrl     String?
  documentStorageKey String?
  ackNumber       String?
  ackDate         DateTime?
  signedPayload   String?
  signatureValidated Boolean @default(false)
  retryCount      Int       @default(0)
  lastSyncAttempt DateTime?
  lastSyncErrorCode String?
  lastSyncErrorMessage String?
  metadata        Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  shipment Shipment @relation(fields: [shipmentId], references: [id])
  invoice  Invoice? @relation(fields: [invoiceId], references: [id])

  @@index([shipmentId])
  @@index([invoiceId])
  @@index([ewayBillNumber])
  @@index([status])
}
